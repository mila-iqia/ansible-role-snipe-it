- name: Host Bootstrap | Install prerequisites
  apt:
    name: [software-properties-common, git, debconf-utils, unzip]
    state: present
  become: true

- name: Host Bootstrap | Purge http servers and php
  apt:
    name: [apache2*, php*, nginx*]
    state: absent
    purge: yes
    autoremove: yes
  become: true
  when: snipe_clean_env

- name: Host Bootstrap | Install PHP 8.1 packages
  apt:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
    - php8.1
    - php-pear
    - php8.1-bcmath
    - php8.1-cli
    - php8.1-common
    - php8.1-curl
    - php8.1-dev
    - php8.1-gd
    - php8.1-intl
    - php8.1-ldap
    - php8.1-mbstring
    - php8.1-mysql
    - php8.1-opcache
    - php8.1-readline
    - php8.1-xml
    - php8.1-zip
  become: true

- name: Host Bootstrap | Install Nginx and PHP-FPM
  apt:
    name: [nginx, php8.1-fpm]
    state: present
  when: snipe_http_server == "nginx"
  become: true

- name: Host Bootstrap | Mysql | Set root password - Ubuntu
  shell: debconf-set-selections <<< "mysql-server mysql-server/root_password password {{ snipe_db_pass }}"
  args:
    executable: /bin/bash
    warn: no
  become: true
  when: ansible_distribution == 'Ubuntu'

- name: Host Bootstrap | Mysql | Set root repassword - Ubuntu
  shell: debconf-set-selections <<< "mysql-server mysql-server/root_password_again password {{ snipe_db_pass }}"
  args:
    executable: /bin/bash
    warn: no
  become: true
  when: ansible_distribution == 'Ubuntu'

- name: Host Bootstrap | Mysql | Install mysql-server - Ubuntu
  apt:
    name: [mysql-server, python-mysqldb]
    state: present
  become: true
  when: ansible_distribution == 'Ubuntu'

- name: Host Bootstrap | Mysql | Install mysql-server - Debian
  apt:
    name: [default-mysql-server, python3-mysqldb]
    state: present
  become: true  
  when: ansible_distribution == 'Debian' and ansible_distribution_version == '11'

- name: Set MySQL root Password - Debian
  become: True
  mysql_user: 
    name: root
    password: "{{ snipe_db_pass }}"
    check_implicit_admin: yes
    login_user: "root"
    login_password: ""
    state: present
  when: ansible_distribution == 'Debian' and ansible_distribution_version == '11'

- name: Host Bootstrap | Mysql | Create database
  mysql_db:
    login_host: "{{ snipe_db_host }}"
    login_port: "{{ snipe_db_port }}"
    login_user: root
    login_password: "{{ snipe_db_pass }}"
    name: "{{ snipe_db_name }}"
    state: present
